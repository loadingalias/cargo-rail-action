name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.0.2)"
        required: true
        type: string
      bump_type:
        description: "What changed?"
        required: true
        type: choice
        options:
          - patch  # Bug fix
          - minor  # New feature (backwards compatible)
          - major  # Breaking change

permissions:
  contents: write

jobs:
  # Tests must pass before releasing
  test:
    uses: ./.github/workflows/test.yaml

  release:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0

      - name: Validate version format
        run: |
          VERSION="${{ inputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid version format. Use x.y.z (e.g., 1.0.2)"
            exit 1
          fi

          if git rev-parse "v$VERSION" &>/dev/null; then
            echo "::error::Tag v$VERSION already exists"
            exit 1
          fi

      - name: Create release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ inputs.version }}
          BUMP_TYPE: ${{ inputs.bump_type }}
        run: |
          MAJOR="v${VERSION%%.*}"  # 1.0.2 -> v1

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create version tag
          git tag -a "v$VERSION" -m "v$VERSION"

          # Update or create floating major tag
          if [[ "$BUMP_TYPE" == "major" ]]; then
            # New major version - create new floating tag
            git tag -a "$MAJOR" -m "$MAJOR: Latest ${MAJOR}.x release"
          else
            # Patch/minor - move existing floating tag
            git tag -fa "$MAJOR" -m "$MAJOR: Latest ${MAJOR}.x release"
          fi

          # Push tags
          git push origin "v$VERSION"
          git push origin "$MAJOR" --force

          # Create GitHub release
          gh release create "v$VERSION" \
            --title "v$VERSION" \
            --generate-notes \
            --latest

          {
            echo "## Released v$VERSION"
            echo ""
            echo "- Tag: \`v$VERSION\`"
            echo "- Floating tag: \`$MAJOR\` â†’ v$VERSION"
          } >> "$GITHUB_STEP_SUMMARY"
